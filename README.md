# doppio

Doppio is a data prototyping tool for humanities research.

Data in the humanities is often complex and richly interlinked.
One of the simplest relationships relevant to humanists is the relation
of author to book. In a traditional relational database, this already
requires not two but three tables to represent, because one book can 
have many authors, and one author can write many books; a third table
is needed to track the is-an-author-of relation between the other two.

Now suppose that you want to represent not books but theatrical
performances. There may be stagehands, actors, prop managers, playwrights,
set designers, directors, makeup artists, and many other contributors
working together to produce a single performance. Most of these 
individuals contribute to multiple performances, sometimes in one role, 
sometimes in another. A faithful representation of these connections in 
a relational database would require an exceptionally complex schema 
that would almost certainly need to be devleoped and tuned over time 
before it could do its job well.

Doppio provides an alternative approach to that tuning process. Using a
NoSQL database ([MongoDB](https://www.mongodb.com/)) combined with a 
flexible schema validation framework and API generator 
([Eve](https://docs.python-eve.org/en/stable/)), Doppio speeds up the 
process of developing a richly expressive data model suitable for 
humanities data. Doppio schemas are easy to modify and update, so that 
as researchers see and enter more data, they can accommodate new findings
quickly. Doppio schemas are also self-documenting; the data entry form
is automatically rendered in a way that makes the structure of the
underlying schema self-evident, even to users who have never worked with
a database at all.

Once the schema reaches a stable point, it can be used as-is with the 
provided database and API, or it can be used as the basis for a more 
structured relational database. Either way, the API makes it easy to 
access the data for analysis, visualization, exploration, and 
preservation.

#### To come:

### The Doppio philosophy
* Put data first
* Make data accessible
  * Uses human-readable JSON/YAML representations for input and output
  * Provides a built-in API
  * ... more features in the future? ...
* Use self-documenting systems
  * Names of JSON/YAML keys must be descriptive b/c they are also the basis for the data entry form
  * Schema can include documentation which is used in the automatically rendered form
* Bake in good data practices
* Create isomorphic data representations


# Getting Started

## Local Setup

In all the following instructions, a value between square braces
(like this: `[some_value]`) is a placeholder for a value of your choice.
In some cases, this value should be a long random string generated by 
a cryptographically secure random number generator (CSRNG). Even
though this is a local testing set-up, we recommend that these be at
least 32 characters long, if only to establish good security habits!

### Settings

To begin with, you'll need appropriate `schema.py` and `setttings.py`
files. We recommend starting out by copying the provided template 
files, which you can then modify as you like. (For information about
creating customized schemas, [see here](https://docs.python-eve.org/en/stable/config.html#schema-definition).)
Inside the project root, run the following commands:

    $ cp settings-template.py settings.py
    $ cp schema-template.py schema.py

### Environment files

To strike a balance between convenience and security, Doppio currently
stores secrets and other environment-specific information in environment
variables, which are themselves read by `docker-compose` from environment
files. These reside in a hidden folder called `.envs`. To create that folder, 
run this command:

    $ mkdir .envs

Inside that folder, create a `.dockerignore` file to ensure that the secrets 
aren't recorded inside built docker images.

    $ cd .envs
    $ touch .dockerignore

Now, create another directory called `.local`:

    $ mkdir .local

In it, create three files, `.caddy`, `.eve` and `.mongo`:

    $ cd .local
    $ touch .caddy
    $ touch .eve
    $ touch .mongo

#### Caddy

Open the `.caddy` file in your preferred text editor, and paste the 
following line:

    DOMAIN_NAME=localhost

#### Mongo

In the `.mongo` file, paste the following lines:

    MONGO_INITDB_ROOT_USERNAME=root
    MONGO_INITDB_ROOT_PASSWORD=[root_password]

Then replace `[root_password]` with a random string generated
by a CSRNG. If you use a password manager like LastPass, you can 
use its password generator to create a suitable string.

#### Eve

In the `.eve` file, paste the following lines:

    EVE_MONGO_USER=[eve_user]
    EVE_MONGO_PASSWORD=[eve_password]
    EVE_TOKEN_SECRET=[eve_token_secret]
    EVE_DATABASE_NAME=[your_db_name]
    
Then make the following replacements:

* Replace `[eve_user]` with the database username that Eve should use. (Most likely something simple like `eve`.) 
* Replace `[eve_password]` with another random string. (This is the password for the Eve database account.)
* Replace `[eve_token_secret]` with another random string. (This is a random seed for authentication token generation.)
* Replace `[your_db_name]` with the name of the mongo database you'd like to use. This can be anything, but 
  it's a good idea to use a memorable, descriptive name.

At this point, your directory structure should look like this:

    doppio
    ├── .envs
    │   ├── .local
    │   │   ├── .mongo
    │   │   ├── .eve
    │   │   ├── .caddy
    │   ├── .dockerignore
    │
    ├── the rest of the app

### Building and launching the app

Now you can use `docker-compose` from the root directory.

    $ docker-compose build

Before launching the server, you'll also need to create a docker volume 
called `playbill-db`. This is where the database itself will be stored.
Creating it manually this way tells `docker-compose` not to delete it
automatically when `docker-compose down` is run!

    $ docker volume create --name=doppio-db

Now you can launch the server with:

    $ docker-compose up

The server should be up and running, and you can see the main form
as rendered here: https://localhost/home

To run the server in the background, stop it by hitting CTRL-C, and 
then restart it using the `-d` flag:

    $ docker-compose up -d

When the server is running in the background, you can view the logs
with this command:

    $ docker-compose logs

### Initializing the database

Although the server runs and displays a data entry form, the underlying database
still needs to be initialized. To do so, first find the MongoDB container.
While the server is running, use this command:

    $ docker ps

This will display get the list of running containers. Look for the container named
`doppio_mongo` and copy the container id, which will look something like `c1fb7f2a2b45`.

Then run the following command, replacing `[container_id]` with the id you copied:

    $ docker exec -it [container_id] /bin/sh

This will open a shell inside the MongoDB container. From there you can launch the
MongoDB client with this command: 

    # mongo -u root

You will be prompted for a password. Enter the password assigned to 
`MONGO_INITDB_ROOT_PASSWORD` inside the `.mongo` environment file.

Inside the shell, create the Eve database with this command, replacing
`[your_db_name]` with the name you assigned to `EVE_DATABASE_NAME`
inside the `.eve` environment file.

    '> use [your_db_name]

Next, create a new user with this command, replacing `[eve_user]` with 
the name you assigned to `EVE_MONGO_USER` and `[eve_password]` with 
the password you assigned to `EVE_MONGO_PASSWORD` (both inside the `.eve`
environment file).

    '> db.createUser({user: "[eve_user]", pwd: "[eve_password]", roles: ["readWrite"]})

You can exit the MongoDB client by pressing CTRL-D, and the MongoDB container shell
by pressing CTRL-D again.

### Creating admin users

Once you've initialized the database, you will need create a admin user for
the Doppio app itself. (Currently, there are only two kinds of users: public 
users with read-only access, and admin users with full access to the database. 
In the future, we hope to implement a more secure, permissions-based system.)

To create an admin user, run the following command:

    $ docker-compose run --rm eve flask createsuperuser

You will be prompted for a username and password, and the user will be created
automatically. You can then use the given username and password to log in to the 
website (by clicking on `Login` on the home page).

To create additional admin users, you can re-run the above command as many times 
as you like.

### Exporting and importing records

#### Exporting records from the database

This command will save each entry currently residing in the database as
its own .json file at the location specified by `[output_folder]`:

    $ docker-compose run --rm eve flask exportjson [output_folder]

#### Importing records into the database

This command will load json files into the database from the location
specified by `[input_folder]`:

    $ docker-compose run --rm eve flask readjson [input_folder]

### Creating database indices

To ensure that records are uniquely identified in a human-readable way,
you'll need to impose a database constraint on the field identified in 
`settings.py` for that purpose: `FILENAME_FIELD = 'myIdField`. (It's called
`FILENAME_FIELD` since this is also the field that will be used as the filename
when records are saved.) To do this, log into the MongoDB client as described
above in **Initializing the database**. Then create a unique index on `myIdField`
using the instructions here: https://docs.mongodb.com/manual/core/index-unique/

In the future we will add keyword searching, which will require a text search
index as well. Instructions for creating a text search index are 
here: https://docs.mongodb.com/manual/text-search/

## Acknowledgements:

This repository contains code from the following repositories:
* https://github.com/senderle/playbill-database-arch
* https://github.com/senderle/pbdb-eve
* https://github.com/senderle/pbdb
* https://github.com/kingtimm/Eve-TokenAuth

And written by the following github users:
* https://github.com/annamarion
* https://github.com/scye09
* https://github.com/SiyuZheng
* https://github.com/ayhanefe
* https://github.com/kingtimm
* https://github.com/senderle

Doppio was created with support from the University of Pennsylvania Libraries, 
the Price Lab for Digital Humanities, and the Andrew W. Mellon Foundation
