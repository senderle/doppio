version: '3'

volumes:
  playbill-db:
    external: true
  caddy_production:

services:

  mongo:
    image: pdb_mongo
    restart: always
    build:
        context: .
        dockerfile: Dockerfile-mongo
    env_file: 
      - ./.envs/.production/.mongo
    volumes:
      - playbill-db:/data/db

  # mongoexpress:
    #   image: mongo-express
    #   restart: always
    #   ports: 
    #     - "8081:8081"
    #   env_file:
    #     - ./.envs/.mongoexpress
    #   depends_on:
    #     - mongo

  eve:
    image: pdb_eve
    build:
        context: .
        dockerfile: Dockerfile
    env_file:
      - ./.envs/.production/.eve
    volumes:
      - .:/code
    working_dir: /code
    depends_on:
      - mongo
    command: python run.py runserver 0.0.0.0:5000

  caddy:
    image: pdb_caddy
    build:
      context: .
      dockerfile: ./compose/caddy/production/Dockerfile
    depends_on:
      - eve
    volumes:
      - caddy_production:/root/.caddy
    env_file:
      - ./.envs/.production/.caddy
    ports:
      - "0.0.0.0:80:80"
      - "0.0.0.0:443:443"
